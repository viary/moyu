<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>æ¯æ—¥æ‘¸é±¼æµ·æŠ¥ - å®Œæ•´ç¾åŒ–ç‰ˆ</title>
  <meta name="description" content="æ¯æ—¥æ‘¸é±¼æµ·æŠ¥ å®˜æ–¹æ¥å£å…¨æ•°æ® è¿›åº¦æ¡å¯è§†åŒ– é«˜æ¸…ç¾è§‚" />
  <meta name="theme-color" content="#fef3c7" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', 'Helvetica Neue',
        Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .brush-text {
      font-weight: 700;
      letter-spacing: 0.1em;
    }
    #drawCanvas { display: none; }
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-orange-50 to-amber-100 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Header -->
    <header class="text-center mb-12">
      <h1 class="text-5xl md:text-6xl font-bold text-amber-800 brush-text mb-4">
        æ¯æ—¥<span class="text-amber-600">æ‘¸é±¼</span>æµ·æŠ¥
      </h1>
      <p class="text-lg text-amber-700 mb-6">å®˜æ–¹æ¥å£å…¨æ•°æ® Â· é«˜æ¸…ç¾è§‚ Â· å¯é•¿æŒ‰ä¿å­˜</p>
      <div class="flex items-center justify-center gap-4 text-amber-600">
        <span id="currentDate" class="text-base"></span>
        <span>âœ¦</span>
        <span class="flex items-center gap-2">
          <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
          æœåŠ¡æ­£å¸¸
        </span>
      </div>
    </header>

    <!-- ä¸»å¡ç‰‡ -->
    <section class="bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl border border-amber-200 p-8">
      <div class="flex flex-col md:flex-row md:items-center justify-between mb-8">
        <h2 class="text-3xl font-bold text-amber-800 brush-text mb-4 md:mb-0">è‡ªå®šä¹‰æ‘¸é±¼æµ·æŠ¥</h2>
        <div class="flex flex-wrap items-center gap-3">
          <input type="date" id="dateInput" class="px-4 py-2.5 bg-amber-50 border border-amber-300 rounded-xl text-amber-800 focus:outline-none focus:ring-2 focus:ring-amber-500" />
          <button onclick="adjustDate(-1)" class="px-4 py-2.5 bg-amber-100 hover:bg-amber-200 rounded-xl transition">â† å‰ä¸€å¤©</button>
          <button onclick="adjustDate(1)" id="nextBtn" class="px-4 py-2.5 bg-amber-100 hover:bg-amber-200 rounded-xl transition disabled:opacity-50 disabled:cursor-not-allowed">åä¸€å¤© â†’</button>
          <button onclick="setToday()" class="px-5 py-2.5 bg-amber-600 hover:bg-amber-700 text-white rounded-xl transition">ä»Šå¤©</button>
        </div>
      </div>

      <!-- ç”»å¸ƒ & ç»“æœå®¹å™¨ -->
      <canvas id="drawCanvas" width="750"></canvas>
      <div id="moYuImageContainer" class="min-h-96 flex flex-col items-center justify-center py-12">
        <div class="text-center text-amber-600">
          <svg class="w-16 h-16 mx-auto mb-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          <p class="text-xl font-medium">é€‰æ‹©æ—¥æœŸåå°†è‡ªåŠ¨ç”Ÿæˆå®Œæ•´æµ·æŠ¥</p>
          <p class="text-sm mt-2 opacity-80">å±•ç¤ºå®˜æ–¹æ¥å£å…¨éƒ¨æ•°æ® Â· è¿›åº¦æ¡é«˜æ¸…å¯è§†åŒ–</p>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-center mt-12 text-amber-700">
      <p class="text-sm">æ•°æ®æ¥æºäº 60s å®˜æ–¹æ‘¸é±¼æ¥å£ Â· çº¯å‰ç«¯ç”Ÿæˆ</p>
      <p class="text-xs mt-2 opacity-70">é•¿æŒ‰æˆ–å³é”®æµ·æŠ¥å¯ä¿å­˜ Â· Vercel ä¸€é”®éƒ¨ç½²</p>
    </footer>
  </div>

  <script>
    // === äºŒç»´ç é…ç½®ï¼ˆè¯·è‡ªè¡Œæ›¿æ¢ï¼‰===
    const QRCODE_BASE64 = ""; // â† åœ¨è¿™é‡Œç²˜è´´ä½ çš„äºŒç»´ç å®Œæ•´ Base64

    const QRCODE_CONFIG = {
      size: 110,
      marginRight: 30,
      scanText: 'æ‰«ç æŸ¥çœ‹æ›´å¤š',
      scanTextSize: 15,
      scanTextGap: 12
    };

    // é¢„åŠ è½½äºŒç»´ç 
    function loadQrCodeImage() {
      return new Promise((resolve, reject) => {
        if (!QRCODE_BASE64) {
          reject(new Error("æœªå¡«å†™äºŒç»´ç "));
          return;
        }
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error("äºŒç»´ç åŠ è½½å¤±è´¥"));
        img.src = QRCODE_BASE64;
      });
    }

    // åˆå§‹åŒ–å‡½æ•°ä»¬ï¼ˆä¸å˜ï¼‰
    function init() {
      const dateInput = document.getElementById('dateInput');
      const today = new Date();
      const todayStr = formatDate(today);
      dateInput.max = todayStr;

      const urlParams = new URLSearchParams(window.location.search);
      const dateParam = urlParams.get('date');
      let initialDate = todayStr;

      if (dateParam && /^\d{4}-\d{2}-\d{2}$/.test(dateParam)) {
        const paramDate = new Date(dateParam);
        const todayDate = new Date(todayStr);
        if (paramDate <= todayDate && !isNaN(paramDate.getTime())) {
          initialDate = dateParam;
        }
      }

      dateInput.value = initialDate;
      updateHeaderDate(new Date(initialDate));
      updateButtonStates();
      drawCustomMoYuImage();
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function updateHeaderDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      const weekDay = weekDays[date.getDay()];
      document.getElementById('currentDate').textContent = `${year}å¹´${month}æœˆ${day}æ—¥ æ˜ŸæœŸ${weekDay}`;
    }

    function getWeekByDateStr(dateStr) {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return '';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return '';
      const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      return `æ˜ŸæœŸ${weekDays[date.getDay()]}`;
    }

    function updateButtonStates() {
      const dateInput = document.getElementById('dateInput');
      const selectedDate = dateInput.value;
      const today = formatDate(new Date());
      const nextBtn = document.getElementById('nextBtn');
      nextBtn.disabled = selectedDate === today;
    }

    function setToday() {
      const today = new Date();
      document.getElementById('dateInput').value = formatDate(today);
      updateButtonStates();
      updateHeaderDate(today);
      drawCustomMoYuImage();
    }

    function adjustDate(days) {
      const dateInput = document.getElementById('dateInput');
      const currentDate = new Date(dateInput.value || new Date());
      currentDate.setDate(currentDate.getDate() + days);
      dateInput.value = formatDate(currentDate);
      updateButtonStates();
      updateHeaderDate(currentDate);
      drawCustomMoYuImage();
    }

    // æ–‡å­—æ¢è¡Œ
    function drawTextWrap(ctx, text, x, y, maxWidth, lineHeight) {
      if (!text) return { finalY: y, totalHeight: 0 };
      const _lineHeight = lineHeight || 38;
      const words = text.split('');
      let line = '';
      let curY = y;
      let lines = 0;

      for (let word of words) {
        const testLine = line + word;
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && line !== '') {
          ctx.fillText(line, x, curY);
          line = word;
          curY += _lineHeight;
          lines++;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, curY);
      lines++;
      return { finalY: curY + _lineHeight, totalHeight: lines * _lineHeight };
    }

    // è¿›åº¦æ¡ï¼ˆå·²ç¾åŒ–ï¼‰
    function drawProgressBar(ctx, x, y, width, height, passed, total, color, label) {
      const percent = Math.round((passed / total) * 100);
      const fillWidth = (passed / total) * width;

      // èƒŒæ™¯
      ctx.fillStyle = '#f3f4f6';
      ctx.roundRect(x, y, width, height, 10);
      ctx.fill();

      // æ¸å˜å¡«å……
      const grad = ctx.createLinearGradient(x, y, x + fillWidth, y);
      grad.addColorStop(0, color);
      grad.addColorStop(1, lightenColor(color, 35));
      ctx.fillStyle = grad;
      ctx.roundRect(x, y, fillWidth, height, 10);
      ctx.fill();

      // æ ‡ç­¾ + ç™¾åˆ†æ¯”
      ctx.fillStyle = '#1f2937';
      ctx.font = 'bold 21px PingFang SC';
      ctx.textAlign = 'left';
      ctx.fillText(label, x, y - 12);

      ctx.fillStyle = color;
      ctx.font = 'bold 24px PingFang SC';
      ctx.textAlign = 'right';
      ctx.fillText(`${percent}% (${passed}/${total})`, x + width, y - 10);

      return y + height + 28;
    }

    function lightenColor(color, percent) {
      const num = parseInt(color.slice(1), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (R>255?255:R)*0x10000 + (G>255?255:G)*0x100 + (B>255?255:B)).toString(16).slice(1);
    }

    function calculateTextBlockHeight(ctx, texts, maxWidth, lineHeight) {
      let h = 0;
      ctx.font = '20px PingFang SC';
      texts.forEach(t => {
        const { totalHeight } = drawTextWrap(ctx, t, 0, 0, maxWidth, lineHeight);
        h += totalHeight + 12;
      });
      return h;
    }

    // æ¥å£æ•°æ®è·å–
    async function fetchOfficialMoYuData(dateStr) {
      try {
        const url = `https://60s.viki.moe/v2/moyu${dateStr ? `?date=${dateStr}` : ''}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('æ¥å£è¿”å›é”™è¯¯');
        const json = await res.json();
        if (json.code !== 200 || !json.data) throw new Error('æ•°æ®æ ¼å¼å¼‚å¸¸');

        const d = json.data;
        const { gregorian, weekday, lunar } = d.date;
        const { yearCN, monthCN, dayCN, yearGanZhi, zodiac } = lunar;

        return {
          dateInfo: {
            gregorian,
            weekday,
            lunar: `${yearCN}${monthCN}${dayCN}`,
            ganZhi: `${yearGanZhi}å¹´${monthCN}${dayCN}`,
            zodiac
          },
          todayState: {
            isWeekend: d.today.isWeekend,
            isHoliday: d.today.isHoliday,
            holidayName: d.today.holidayName || 'æ— ',
            solarTerm: d.today.solarTerm || 'æ— ',
            lunarFestivals: lunar.lunarFestivals.length ? lunar.lunarFestivals.join('ã€') : 'æ— '
          },
          progressData: d.progress,
          holidayData: {
            current: d.currentHoliday ? `${d.currentHoliday.name}ï¼ˆå‰©ä½™${d.currentHoliday.daysRemaining}å¤©ï¼‰` : 'æ— å½“å‰å‡æœŸ',
            next: d.nextHoliday ? `${d.nextHoliday.name}ï¼ˆ${d.nextHoliday.date}ï¼Œè¿˜æœ‰${d.nextHoliday.until}å¤©ï¼‰` : 'æ— åç»­å‡æœŸ',
            nextWeekend: `${d.nextWeekend.weekday}ï¼ˆ${d.nextWeekend.date}ï¼Œè¿˜æœ‰${d.nextWeekend.daysUntil}å¤©ï¼‰`
          },
          countdownData: d.countdown,
          moyuQuote: d.moyuQuote || 'æ‘¸é±¼ä¸€æ—¶çˆ½ï¼Œä¸€ç›´æ‘¸é±¼ä¸€ç›´çˆ½ï½'
        };
      } catch (e) {
        console.warn('æ¥å£è·å–å¤±è´¥ï¼Œä½¿ç”¨å…œåº•æ•°æ®', e);
        // å…œåº•ï¼ˆä»…åœ¨æ¥å£å®Œå…¨ä¸å¯ç”¨æ—¶æ˜¾ç¤ºâ€œç¤ºä¾‹â€ï¼‰
        const date = new Date(dateStr || new Date());
        return {
          dateInfo: { gregorian: formatDate(date), weekday: getWeekByDateStr(formatDate(date)), lunar: 'å†œå†æ•°æ®è·å–å¤±è´¥', ganZhi: 'å¹²æ”¯æ•°æ®è·å–å¤±è´¥', zodiac: 'ç”Ÿè‚–è·å–å¤±è´¥' },
          todayState: { isWeekend: false, isHoliday: false, holidayName: 'æ— ', solarTerm: 'æ— ', lunarFestivals: 'æ— ' },
          progressData: { week: {passed: 3, total: 7, percentage: 43}, month: {passed: 15, total: 31, percentage: 48}, year: {passed: 200, total: 365, percentage: 55} },
          holidayData: { current: 'æ— å½“å‰å‡æœŸ', next: 'æ— åç»­å‡æœŸ', nextWeekend: 'æ— å‘¨æœ«æ•°æ®' },
          countdownData: { toWeekEnd: 2, toFriday: 1, toMonthEnd: 16, toYearEnd: 165 },
          moyuQuote: 'æ‘¸é±¼ä¸æ˜¯å·æ‡’ï¼Œæ˜¯æˆ˜ç•¥æ€§ä¼‘æ¯ï½'
        };
      }
    }

    // æ ¸å¿ƒç»˜åˆ¶ï¼ˆä¿®å¤å€’è®¡æ—¶æº¢å‡º + æ›´å®½æ¾æ’ç‰ˆï¼‰
    async function drawCustomMoYuImage() {
      const date = document.getElementById('dateInput').value;
      if (!date) return;

      const container = document.getElementById('moYuImageContainer');
      container.innerHTML = `<div class="text-center py-20"><svg class="w-16 h-16 mx-auto mb-6 animate-spin text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><p class="text-xl text-amber-700 font-medium">æ­£åœ¨ç”Ÿæˆ...</p></div>`;

      try {
        const [qrImg, data] = await Promise.all([loadQrCodeImage().catch(() => null), fetchOfficialMoYuData(date)]);

        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const w = 750;
        const pad = 70;
        const maxW = w - pad * 2;

        const style = {
          title: 'bold 40px PingFang SC',
          subtitle: '24px PingFang SC',
          label: 'bold 23px PingFang SC',
          content: '20px PingFang SC',
          quote: 'bold 26px PingFang SC',
          lineH: 38,
          gap: 40,
          colors: { week: '#60a5fa', month: '#34d399', year: '#fb923c' }
        };

        // æ–‡æœ¬å—ï¼ˆå€’è®¡æ—¶å·²æ‹†è¡Œï¼Œé¿å…æº¢å‡ºï¼‰
        const todayTexts = [
          `çŠ¶æ€ï¼š${data.todayState.isWeekend ? 'ğŸŸ¢ å‘¨æœ«' : data.todayState.isHoliday ? `ğŸŸ¡ èŠ‚å‡æ—¥ï¼ˆ${data.todayState.holidayName}ï¼‰` : 'ğŸ”´ å·¥ä½œæ—¥'}`,
          `èŠ‚æ°”ï¼š${data.todayState.solarTerm}`,
          `å†œå†èŠ‚æ—¥ï¼š${data.todayState.lunarFestivals}`
        ];

        const holidayTexts = [
          `å½“å‰å‡æœŸï¼š${data.holidayData.current}`,
          `ä¸‹æ¬¡å‡æœŸï¼š${data.holidayData.next}`,
          `ä¸‹æ¬¡å‘¨æœ«ï¼š${data.holidayData.nextWeekend}`,
          `è·å‘¨æœ«ï¼š${data.countdownData.toWeekEnd} å¤©`,
          `è·æ˜ŸæœŸäº”ï¼š${data.countdownData.toFriday} å¤©`,
          `è·æœˆæœ«ï¼š${data.countdownData.toMonthEnd} å¤©`,
          `è·å¹´æœ«ï¼š${data.countdownData.toYearEnd} å¤©`
        ];

        // é¢„è®¡ç®—é«˜åº¦ï¼ˆå¢åŠ å®‰å…¨è£•é‡ï¼‰
        ctx.font = style.content;
        const todayH = calculateTextBlockHeight(ctx, todayTexts, maxW, style.lineH);
        const holidayH = calculateTextBlockHeight(ctx, holidayTexts, maxW, style.lineH);

        let totalH = 200 + todayH + holidayH + 280 + 200; // é¢å¤–è£•é‡é˜²æº¢å‡º
        canvas.height = Math.max(1300, totalH);

        ctx.fillStyle = '#fffbeb';
        ctx.fillRect(0, 0, w, canvas.height);

        let y = 90;

        // æ ‡é¢˜ + å‰¯æ ‡é¢˜
        ctx.fillStyle = '#7c2d12';
        ctx.font = style.title;
        ctx.textAlign = 'center';
        ctx.fillText(`æ¯æ—¥æ‘¸é±¼æµ·æŠ¥ Â· ${data.dateInfo.gregorian} ${data.dateInfo.weekday}`, w/2, y);
        y += 55;
        ctx.font = style.subtitle;
        ctx.fillStyle = '#d97706';
        ctx.fillText(`${data.dateInfo.lunar} Â· ${data.dateInfo.ganZhi} Â· ${data.dateInfo.zodiac}`, w/2, y);
        y += 90;

        // è¯­å½•
        ctx.fillStyle = 'rgba(251,191,36,0.15)';
        ctx.fillRect(pad-15, y-25, maxW+30, 90);
        ctx.fillStyle = '#b45309';
        ctx.font = style.quote;
        ctx.fillText(`ğŸ’¬ ${data.moyuQuote}`, w/2, y+35);
        y += 130;

        // ä»Šæ—¥çŠ¶æ€
        ctx.fillStyle = '#374151';
        ctx.font = style.label;
        ctx.textAlign = 'left';
        ctx.fillText('ä»Šæ—¥çŠ¶æ€', pad, y);
        y += style.gap;
        ctx.fillStyle = '#1e293b';
        ctx.font = style.content;
        todayTexts.forEach(t => {
          const { finalY } = drawTextWrap(ctx, t, pad, y, maxW, style.lineH);
          y = finalY + 8;
        });
        y += style.gap - 10;

        // è¿›åº¦æ¡
        ctx.fillStyle = '#374151';
        ctx.font = style.label;
        ctx.fillText('æ—¶é—´è¿›åº¦', pad, y);
        y += 55;

        y = drawProgressBar(ctx, pad, y, maxW, 34, data.progressData.week.passed, data.progressData.week.total, style.colors.week, 'æœ¬å‘¨å·²è¿‡');
        y = drawProgressBar(ctx, pad, y, maxW, 34, data.progressData.month.passed, data.progressData.month.total, style.colors.month, 'æœ¬æœˆå·²è¿‡');
        y = drawProgressBar(ctx, pad, y, maxW, 34, data.progressData.year.passed, data.progressData.year.total, style.colors.year, 'ä»Šå¹´å·²è¿‡');

        y += style.gap - 20;

        // å‡æœŸå€’è®¡æ—¶ï¼ˆå·²æ‹†è¡Œï¼‰
        ctx.fillStyle = '#374151';
        ctx.font = style.label;
        ctx.fillText('å‡æœŸå€’è®¡æ—¶', pad, y);
        y += style.gap;
        ctx.fillStyle = '#1e293b';
        ctx.font = style.content;
        holidayTexts.forEach(t => {
          const { finalY } = drawTextWrap(ctx, t, pad, y, maxW, style.lineH);
          y = finalY + 8;
        });

        // äºŒç»´ç  + åº•éƒ¨æ–‡å­—
        if (qrImg) {
          const qrX = w - QRCODE_CONFIG.size - QRCODE_CONFIG.marginRight;
          const qrY = canvas.height - QRCODE_CONFIG.size - 60;
          ctx.drawImage(qrImg, qrX, qrY, QRCODE_CONFIG.size, QRCODE_CONFIG.size);
          ctx.fillStyle = '#6b7280';
          ctx.font = `${QRCODE_CONFIG.scanTextSize}px PingFang SC`;
          ctx.textAlign = 'right';
          ctx.fillText(QRCODE_CONFIG.scanText, qrX - QRCODE_CONFIG.scanTextGap, qrY + QRCODE_CONFIG.size / 2 + 8);
        }

        ctx.fillStyle = '#9ca3af';
        ctx.font = '18px PingFang SC';
        ctx.textAlign = 'center';
        ctx.fillText('æ¯æ—¥æ‘¸é±¼æµ·æŠ¥ Â· å®˜æ–¹æ¥å£å…¨æ•°æ®', w/2, canvas.height - 40);

        const url = canvas.toDataURL('image/png', 1.0);
        container.innerHTML = `
          <div class="bg-white rounded-2xl shadow-xl p-8 border border-amber-100">
            <img src="${url}" alt="æ‘¸é±¼æµ·æŠ¥" class="w-full rounded-xl shadow-lg">
            <p class="text-center text-sm text-gray-600 mt-6">é•¿æŒ‰æˆ–å³é”®ä¿å­˜å›¾ç‰‡</p>
          </div>
        `;
      } catch (err) {
        container.innerHTML = `<div class="text-center py-12 text-red-600">ç”Ÿæˆå¤±è´¥ï¼š${err.message}<br><span class="text-sm text-gray-600">è¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é‡è¯•</span></div>`;
      }
    }

    // å¯åŠ¨
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
