<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>æ¯æ—¥æ‘¸é±¼æµ·æŠ¥ - æ¸…çˆ½æ’ç‰ˆç‰ˆ</title>
    <meta name="description" content="æ¯æ—¥æ‘¸é±¼æµ·æŠ¥ æ’ç‰ˆè§„æ•´ æ— é‡å  æ— ä¹±ç " />
    <meta name="theme-color" content="#fef3c7" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue',
                Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .brush-text {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15);
            letter-spacing: 0.05em;
            font-family: 'Noto Serif SC', serif;
        }
        
        .seal {
            writing-mode: vertical-rl;
            text-orientation: upright;
            border: 2px solid currentColor;
            border-radius: 8px;
            padding: 0.75rem 0.5rem;
            font-weight: 700;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to bottom, #fed7aa, #fdba74);
        }
        
        .poster-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .poster-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #f59e0b, #fbbf24, #f59e0b);
            z-index: 10;
        }
        
        .btn {
            transition: all 0.3s ease;
            border-radius: 10px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        input[type="date"] {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 0.5rem 1rem;
            font-family: 'Noto Sans SC', sans-serif;
            background: white;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        input[type="date"]:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #f59e0b;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #drawCanvas {
            display: none;
        }
        
        @media (max-width: 640px) {
            .poster-container {
                border-radius: 12px;
                margin: 0 10px;
            }
            
            input[type="date"] {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-stone-800 brush-text mb-4">
                æ¯æ—¥<span class="text-amber-700">æ‘¸é±¼</span>ä¸“å±æµ·æŠ¥
            </h1>
            <p class="text-stone-600 text-lg">ç²¾å¿ƒæ’ç‰ˆ Â· é«˜æ¸…å¯ä¿å­˜ Â· æ¯æ—¥æ›´æ–°</p>
        </header>

        <section class="poster-container p-4 md:p-8 mb-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 pb-6 border-b border-stone-200">
                <div class="flex items-center gap-4">
                    <div class="seal text-amber-900 text-sm hidden md:block">æ‘¸é±¼ä¸“ç”¨</div>
                    <div>
                        <h2 class="text-2xl font-bold text-stone-800">è‡ªå®šä¹‰æ‘¸é±¼æµ·æŠ¥</h2>
                        <p class="text-stone-500 text-sm">é€‰æ‹©æ—¥æœŸç”Ÿæˆä¸“å±æµ·æŠ¥</p>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1">
                        <input 
                            type="date" 
                            id="dateInput" 
                            onchange="generatePoster()" 
                            class="w-full px-4 py-2.5 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                        />
                    </div>
                    <div class="flex gap-2">
                        <button onclick="setToday()" class="btn btn-primary px-4 py-2.5 flex-1">
                            ä»Šå¤©
                        </button>
                        <button onclick="downloadPoster()" id="downloadBtn" class="btn btn-secondary px-4 py-2.5 flex-1 hidden">
                            ä¸‹è½½æµ·æŠ¥
                        </button>
                    </div>
                </div>
            </div>
            
            <canvas id="drawCanvas"></canvas>
            
            <div id="posterContainer" class="min-h-[300px] flex flex-col items-center justify-center p-6">
                <div class="loading mb-4"></div>
                <p class="text-stone-600">æ­£åœ¨ç”Ÿæˆç²¾ç¾æµ·æŠ¥...</p>
            </div>
        </section>
        
        <footer class="text-center text-stone-500 text-sm mt-12 px-4">
            <p>æ•°æ®æ¥æºï¼šæ‘¸é±¼ API | æ¯æ—¥æ›´æ–° | ä»…ä¾›å¨±ä¹ä½¿ç”¨</p>
            <p class="mt-2">Â© 2024 æ‘¸é±¼æµ·æŠ¥ç”Ÿæˆå™¨ | æœ¬æ—¥å®œé€‚å½“æ”¾æ¾ï¼Œä¿æŒå·¥ä½œæ•ˆç‡</p>
        </footer>
    </div>

    <script>
        // ============================================
        // ğŸ¯ äºŒç»´ç é…ç½®ï¼ˆè¯·æ›¿æ¢æˆä½ è‡ªå·±çš„äºŒç»´ç Base64æ•°æ®ï¼‰
        // ============================================
        const QR_CODE_BASE64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQMAAABmvDolAAAAA1BMVEUAAACnej3aAAAAH0lEQVR42u3BMQEAAADCoPVPbQwfoAAAAAAAAAAAAAAAAADeGEMCAAEF9JhTAAAAAElFTkSuQmCC"; // æ›¿æ¢è¿™é‡Œ

        // æµ·æŠ¥å°ºå¯¸é…ç½®
        const POSTER_CONFIG = {
            width: 750,
            padding: 50,
            colors: {
                primary: '#7c2d12',
                secondary: '#d97706',
                accent: '#f59e0b',
                textDark: '#1e293b',
                textMedium: '#334155',
                textLight: '#6b7280',
                bgLight: 'rgba(251, 191, 36, 0.08)',
                progressWeek: '#3b82f6',
                progressMonth: '#10b981',
                progressYear: '#f97316',
                borderLight: '#e5e7eb'
            }
        };

        // æ–‡æœ¬æ¸²æŸ“å™¨
        class TextRenderer {
            constructor(ctx) {
                this.ctx = ctx;
            }
            
            setStyle(size, weight = 'normal', family = '"Noto Sans SC"') {
                this.ctx.font = `${weight} ${size}px ${family}`;
                return this;
            }
            
            drawCentered(text, x, y, size = 42, weight = 'bold', color = POSTER_CONFIG.colors.primary) {
                this.setStyle(size, weight, '"Noto Serif SC"');
                this.ctx.fillStyle = color;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'top';
                this.ctx.fillText(text, x, y);
                return y + size * 1.5;
            }
            
            drawLeft(text, x, y, size = 18, weight = 'normal', color = POSTER_CONFIG.colors.textMedium) {
                this.setStyle(size, weight);
                this.ctx.fillStyle = color;
                this.ctx.textAlign = 'left';
                this.ctx.textBaseline = 'top';
                this.ctx.fillText(text, x, y);
                return y + size * 1.5;
            }
            
            drawRight(text, x, y, size = 16, weight = 'normal', color = POSTER_CONFIG.colors.textLight) {
                this.setStyle(size, weight);
                this.ctx.fillStyle = color;
                this.ctx.textAlign = 'right';
                this.ctx.textBaseline = 'top';
                this.ctx.fillText(text, x, y);
                return y + size * 1.5;
            }
        }

        // è¿›åº¦æ¡ç»˜åˆ¶å™¨ - å®Œå…¨é‡æ–°è®¾è®¡ï¼Œé¿å…é‡å 
        class ProgressBarRenderer {
            constructor(ctx, textRenderer) {
                this.ctx = ctx;
                this.textRenderer = textRenderer;
            }
            
            draw(x, y, width, progress, color, label, value) {
                const height = 28;
                const radius = height / 2;
                
                // ç»˜åˆ¶æ ‡ç­¾å’Œç™¾åˆ†æ¯”ï¼ˆåœ¨è¿›åº¦æ¡ä¸Šæ–¹ï¼Œå¢åŠ é—´è·ï¼‰
                this.textRenderer.setStyle(16, 'bold');
                this.ctx.fillStyle = POSTER_CONFIG.colors.textDark;
                this.ctx.textAlign = 'left';
                this.ctx.fillText(label, x, y - 15);
                
                this.ctx.fillStyle = color;
                this.ctx.textAlign = 'right';
                this.ctx.fillText(value, x + width, y - 15);
                
                // ç»˜åˆ¶è¿›åº¦æ¡èƒŒæ™¯
                this.ctx.fillStyle = '#f3f4f6';
                this.roundRect(x, y, width, height, radius);
                this.ctx.fill();
                
                // ç»˜åˆ¶è¿›åº¦æ¡å¡«å……
                if (progress > 0) {
                    this.ctx.fillStyle = color;
                    const fillWidth = width * Math.min(progress, 1);
                    this.roundRect(x, y, fillWidth, height, radius);
                    this.ctx.fill();
                    
                    // æ·»åŠ å…‰æ•ˆ
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    this.roundRect(x, y, fillWidth, height / 3, radius);
                    this.ctx.fill();
                }
                
                // åœ¨è¿›åº¦æ¡å†…éƒ¨æ˜¾ç¤ºå…·ä½“å¤©æ•°ï¼ˆå¯é€‰ï¼‰
                this.ctx.fillStyle = '#fff';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                const dayText = `${Math.round(progress * 100)}%`;
                if (width * progress > 50) { // åªåœ¨è¿›åº¦æ¡è¶³å¤Ÿå®½æ—¶æ˜¾ç¤º
                    this.ctx.fillText(dayText, x + (width * progress) / 2, y + height / 2);
                }
                
                // è¿”å›ä¸‹ä¸€ä¸ªè¿›åº¦æ¡çš„yåæ ‡ï¼ˆå¢åŠ é—´è·ï¼‰
                return y + height + 45; // ä»30å¢åŠ åˆ°45ï¼Œå¢åŠ é—´è·
            }
            
            roundRect(x, y, width, height, radius) {
                this.ctx.beginPath();
                this.ctx.moveTo(x + radius, y);
                this.ctx.lineTo(x + width - radius, y);
                this.ctx.arcTo(x + width, y, x + width, y + radius, radius);
                this.ctx.lineTo(x + width, y + height - radius);
                this.ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                this.ctx.lineTo(x + radius, y + height);
                this.ctx.arcTo(x, y + height, x, y + height - radius, radius);
                this.ctx.lineTo(x, y + radius);
                this.ctx.arcTo(x, y, x + radius, y, radius);
                this.ctx.closePath();
            }
        }

        // äºŒç»´ç ç»˜åˆ¶å™¨
        class QRCodeManager {
            constructor(ctx, textRenderer) {
                this.ctx = ctx;
                this.textRenderer = textRenderer;
            }
            
            async draw(x, y, size = 85) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        // ç»˜åˆ¶ç™½è‰²åœ†è§’èƒŒæ™¯
                        this.ctx.fillStyle = 'white';
                        this.roundRect(x - 8, y - 8, size + 16, size + 16, 12);
                        this.ctx.fill();
                        
                        // ç»˜åˆ¶é‡‘è‰²è¾¹æ¡†
                        this.ctx.strokeStyle = POSTER_CONFIG.colors.accent;
                        this.ctx.lineWidth = 2;
                        this.roundRect(x - 8, y - 8, size + 16, size + 16, 12);
                        this.ctx.stroke();
                        
                        // ç»˜åˆ¶äºŒç»´ç 
                        this.ctx.drawImage(img, x, y, size, size);
                        
                        // ç»˜åˆ¶æç¤ºæ–‡å­—ï¼ˆæ”¾åœ¨äºŒç»´ç ä¸Šæ–¹ï¼Œç•™å‡ºè¶³å¤Ÿé—´è·ï¼‰
                        this.textRenderer.setStyle(14, 'bold');
                        this.ctx.fillStyle = POSTER_CONFIG.colors.textMedium;
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText('æ‰«ç æŸ¥çœ‹æ›´å¤š', x + size/2, y - 25);
                        
                        resolve();
                    };
                    img.onerror = () => {
                        // ç»˜åˆ¶å ä½ç¬¦
                        this.ctx.fillStyle = '#f3f4f6';
                        this.roundRect(x, y, size, size, 8);
                        this.ctx.fill();
                        
                        this.ctx.strokeStyle = POSTER_CONFIG.colors.accent;
                        this.ctx.lineWidth = 1;
                        this.roundRect(x, y, size, size, 8);
                        this.ctx.stroke();
                        
                        this.textRenderer.setStyle(14, 'bold');
                        this.ctx.fillStyle = POSTER_CONFIG.colors.textMedium;
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText('æ‰«ç æŸ¥çœ‹æ›´å¤š', x + size/2, y + size/2);
                        
                        resolve();
                    };
                    img.src = QR_CODE_BASE64;
                });
            }
            
            roundRect(x, y, width, height, radius) {
                this.ctx.beginPath();
                this.ctx.moveTo(x + radius, y);
                this.ctx.lineTo(x + width - radius, y);
                this.ctx.arcTo(x + width, y, x + width, y + radius, radius);
                this.ctx.lineTo(x + width, y + height - radius);
                this.ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                this.ctx.lineTo(x + radius, y + height);
                this.ctx.arcTo(x, y + height, x, y + height - radius, radius);
                this.ctx.lineTo(x, y + radius);
                this.ctx.arcTo(x, y, x + radius, y, radius);
                this.ctx.closePath();
            }
        }

        // æ•°æ®è·å–
        async function getMoYuData(date) {
            try {
                const res = await fetch(`https://60s.viki.moe/v2/moyu?date=${date}`);
                const data = await res.json();
                if (data.code !== 200) throw new Error();
                return data.data;
            } catch (e) {
                // å…œåº•æ•°æ®
                const today = new Date();
                return {
                    date: { 
                        gregorian: date, 
                        weekday: ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][today.getDay()], 
                        lunar: { 
                            monthCN: 'è…Šæœˆ', 
                            dayCN: 'åä¸‰', 
                            yearGanZhi: 'ä¹™å·³', 
                            zodiac: 'è›‡' 
                        } 
                    },
                    today: { 
                        isWeekend: today.getDay() === 0 || today.getDay() === 6, 
                        solarTerm: 'æ— ' 
                    },
                    progress: { 
                        week: { passed: 6, total: 7 }, 
                        month: { passed: today.getDate(), total: new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate() }, 
                        year: { passed: Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000), total: 365 } 
                    },
                    nextHoliday: { name: 'æ˜¥èŠ‚', date: '2026-02-16', until: 16 },
                    moyuQuote: 'æ‘¸é±¼ä¸æ˜¯å·æ‡’ï¼Œæ˜¯ä¸ºäº†æ›´å¥½çš„å·¥ä½œï½'
                };
            }
        }

        // æµ·æŠ¥ç”Ÿæˆå™¨
        class PosterGenerator {
            constructor() {
                this.canvas = document.getElementById('drawCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.textRenderer = new TextRenderer(this.ctx);
                this.progressBarRenderer = new ProgressBarRenderer(this.ctx, this.textRenderer);
                this.qrManager = new QRCodeManager(this.ctx, this.textRenderer);
                this.padding = POSTER_CONFIG.padding;
                this.width = POSTER_CONFIG.width;
                this.contentWidth = this.width - this.padding * 2;
            }
            
            async generate(date) {
                try {
                    this.data = await getMoYuData(date);
                    
                    // è®¡ç®—æ‰€éœ€é«˜åº¦
                    const neededHeight = this.calculateHeight();
                    
                    // è®¾ç½®ç”»å¸ƒå°ºå¯¸ï¼ˆç•™å‡ºè¶³å¤Ÿè¾¹è·ï¼‰
                    this.canvas.width = this.width;
                    this.canvas.height = Math.max(neededHeight, 1200);
                    
                    // ç»˜åˆ¶æµ·æŠ¥
                    await this.drawPoster();
                    
                    return this.canvas.toDataURL('image/png');
                    
                } catch (error) {
                    console.error('æµ·æŠ¥ç”Ÿæˆå¤±è´¥:', error);
                    throw error;
                }
            }
            
            calculateHeight() {
                let height = this.padding * 2; // ä¸Šä¸‹è¾¹è·
                
                // æ ‡é¢˜åŒº
                height += 160;
                
                // ä»Šæ—¥çŠ¶æ€
                height += 90;
                if (this.data.today.solarTerm && this.data.today.solarTerm !== 'æ— ') {
                    height += 25;
                }
                
                // è¿›åº¦æ¡åŒºï¼ˆå¢åŠ é—´è·ï¼‰
                height += 50 + (3 * 65); // æ ‡é¢˜ + 3ä¸ªè¿›åº¦æ¡ï¼ˆå¢åŠ é—´è·ï¼‰
                
                // å‡æœŸä¿¡æ¯
                height += 60 + (30 * 4); // æ ‡é¢˜ + 4è¡Œä¿¡æ¯
                
                // æ‘¸é±¼è¯­å½•
                height += 140;
                
                // åº•éƒ¨ä¿¡æ¯åŒºï¼ˆç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ï¼‰
                height += 180; // å¢åŠ åº•éƒ¨åŒºåŸŸé«˜åº¦
                
                return height;
            }
            
            async drawPoster() {
                let y = this.padding;
                
                // æ¸…ç©ºç”»å¸ƒ
                this.clearCanvas();
                
                // 1. æ ‡é¢˜åŒº
                y = this.textRenderer.drawCentered('æ¯æ—¥æ‘¸é±¼æµ·æŠ¥', this.width / 2, y, 42, 'bold', POSTER_CONFIG.colors.primary);
                y = this.textRenderer.drawCentered(`${this.data.date.gregorian} ${this.data.date.weekday}`, this.width / 2, y - 15, 26, 'normal', POSTER_CONFIG.colors.secondary);
                y = this.textRenderer.drawCentered(
                    `${this.data.date.lunar.monthCN}${this.data.date.lunar.dayCN} Â· ${this.data.date.lunar.yearGanZhi}å¹´ Â· ç”Ÿè‚–${this.data.date.lunar.zodiac}`,
                    this.width / 2, y, 20, 'normal', '#92400e'
                );
                
                // åˆ†éš”çº¿
                this.drawDivider(y + 20);
                y += 50;
                
                // 2. ä»Šæ—¥çŠ¶æ€
                y = this.textRenderer.drawLeft('ğŸ“‹ ä»Šæ—¥çŠ¶æ€', this.padding, y, 24, 'bold', POSTER_CONFIG.colors.textDark);
                y += 35;
                
                const statusIcon = this.data.today.isWeekend ? 'ğŸ‰' : 'ğŸ’¼';
                const statusText = this.data.today.isWeekend ? 'å‘¨æœ«æ„‰å¿« Â· æ”¾è‚†æ‘¸é±¼' : 'å·¥ä½œæ—¥ Â· è°¨æ…æ‘¸é±¼';
                y = this.textRenderer.drawLeft(`${statusIcon} ${statusText}`, this.padding, y, 20, 'normal', POSTER_CONFIG.colors.textMedium);
                
                if (this.data.today.solarTerm && this.data.today.solarTerm !== 'æ— ') {
                    y = this.textRenderer.drawLeft(`â€¢ èŠ‚æ°”ï¼š${this.data.today.solarTerm}`, this.padding, y + 5, 18, 'normal', POSTER_CONFIG.colors.textMedium);
                }
                
                y += 35;
                
                // 3. è¿›åº¦æ¡ï¼ˆé‡æ–°è®¾è®¡ï¼Œå¢åŠ é—´è·ï¼‰
                y = this.textRenderer.drawLeft('ğŸ“Š æ—¶é—´è¿›åº¦', this.padding, y, 24, 'bold', POSTER_CONFIG.colors.textDark);
                y += 45;
                
                // æœ¬å‘¨è¿›åº¦
                const weekProgress = this.data.progress.week.passed / this.data.progress.week.total;
                y = this.progressBarRenderer.draw(
                    this.padding, y, this.contentWidth, weekProgress,
                    POSTER_CONFIG.colors.progressWeek,
                    'æœ¬å‘¨è¿›åº¦',
                    `${this.data.progress.week.passed}/${this.data.progress.week.total}å¤©`
                );
                
                // æœ¬æœˆè¿›åº¦
                const monthProgress = this.data.progress.month.passed / this.data.progress.month.total;
                y = this.progressBarRenderer.draw(
                    this.padding, y, this.contentWidth, monthProgress,
                    POSTER_CONFIG.colors.progressMonth,
                    'æœ¬æœˆè¿›åº¦',
                    `${this.data.progress.month.passed}/${this.data.progress.month.total}å¤©`
                );
                
                // ä»Šå¹´è¿›åº¦
                const yearProgress = this.data.progress.year.passed / this.data.progress.year.total;
                y = this.progressBarRenderer.draw(
                    this.padding, y, this.contentWidth, yearProgress,
                    POSTER_CONFIG.colors.progressYear,
                    'ä»Šå¹´è¿›åº¦',
                    `${this.data.progress.year.passed}/${this.data.progress.year.total}å¤©`
                );
                
                y += 30;
                
                // 4. å‡æœŸä¿¡æ¯
                y = this.textRenderer.drawLeft('â³ å‡æœŸä¿¡æ¯', this.padding, y, 24, 'bold', POSTER_CONFIG.colors.textDark);
                y += 40;
                
                const holidayLines = [
                    `â€¢ ä¸‹æ¬¡å‡æœŸï¼š${this.data.nextHoliday.name}`,
                    `â€¢ æ”¾å‡æ—¥æœŸï¼š${this.data.nextHoliday.date}`,
                    `â€¢ å€’è®¡æ—¶ï¼šè¿˜æœ‰ ${this.data.nextHoliday.until} å¤©`,
                    `â€¢ è·ç¦»å¹´æœ«ï¼š${365 - this.data.progress.year.passed} å¤©`
                ];
                
                holidayLines.forEach(line => {
                    y = this.textRenderer.drawLeft(line, this.padding, y, 20, 'normal', POSTER_CONFIG.colors.textMedium);
                });
                
                y += 40;
                
                // 5. æ‘¸é±¼è¯­å½•
                this.ctx.fillStyle = POSTER_CONFIG.colors.bgLight;
                this.roundRect(this.padding - 15, y - 10, this.contentWidth + 30, 100, 15);
                this.ctx.fill();
                
                // ç»˜åˆ¶å¼•å·è£…é¥°
                this.textRenderer.setStyle(36, 'bold');
                this.ctx.fillStyle = POSTER_CONFIG.colors.accent;
                this.ctx.textAlign = 'left';
                this.ctx.fillText('â', this.padding - 5, y + 10);
                this.ctx.textAlign = 'right';
                this.ctx.fillText('â', this.width - this.padding - 5, y + 60);
                
                this.textRenderer.setStyle(20, 'bold', '"Noto Serif SC"');
                this.ctx.fillStyle = '#78350f';
                this.ctx.textAlign = 'center';
                
                // å¤„ç†æ‘¸é±¼è¯­å½•æ¢è¡Œ
                const quote = this.data.moyuQuote;
                const maxLineWidth = this.contentWidth - 80;
                
                const words = quote.split('');
                let line = '';
                let lineY = y + 35;
                const lineHeight = 26;
                
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i];
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxLineWidth && line !== '') {
                        this.ctx.fillText(line, this.width / 2, lineY);
                        line = words[i];
                        lineY += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                
                if (line) {
                    this.ctx.fillText(line, this.width / 2, lineY);
                }
                
                y = lineY + lineHeight + 30;
                
                // 6. ç»˜åˆ¶åº•éƒ¨ä¿¡æ¯ï¼ˆç¡®ä¿ä¸ä¼šè¶…å‡ºï¼‰
                await this.drawFooter(y);
            }
            
            clearCanvas() {
                this.ctx.fillStyle = '#fffaf0';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶é‡‘è‰²è¾¹æ¡†ï¼ˆç¡®ä¿è¾¹æ¡†å†…ç¼©ï¼Œä¸è£å‰ªå†…å®¹ï¼‰
                this.ctx.strokeStyle = '#fbbf24';
                this.ctx.lineWidth = 4;
                this.ctx.strokeRect(15, 15, this.canvas.width - 30, this.canvas.height - 30);
            }
            
            drawDivider(y) {
                this.ctx.strokeStyle = '#fbbf24';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(this.padding, y);
                this.ctx.lineTo(this.width - this.padding, y);
                this.ctx.stroke();
            }
            
            roundRect(x, y, width, height, radius) {
                this.ctx.beginPath();
                this.ctx.moveTo(x + radius, y);
                this.ctx.lineTo(x + width - radius, y);
                this.ctx.arcTo(x + width, y, x + width, y + radius, radius);
                this.ctx.lineTo(x + width, y + height - radius);
                this.ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                this.ctx.lineTo(x + radius, y + height);
                this.ctx.arcTo(x, y + height, x, y + height - radius, radius);
                this.ctx.lineTo(x, y + radius);
                this.ctx.arcTo(x, y, x + radius, y, radius);
                this.ctx.closePath();
            }
            
            async drawFooter(startY) {
                const width = this.width;
                let y = startY;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´
                const footerHeight = 200; // é¢„ä¼°åº•éƒ¨åŒºåŸŸé«˜åº¦
                const availableSpace = this.canvas.height - y - this.padding;
                
                // å¦‚æœç©ºé—´ä¸è¶³ï¼Œè°ƒæ•´yåæ ‡
                if (availableSpace < footerHeight) {
                    // å¢åŠ ç”»å¸ƒé«˜åº¦
                    this.canvas.height = this.canvas.height + (footerHeight - availableSpace) + 50;
                    // é‡æ–°ç»˜åˆ¶èƒŒæ™¯
                    this.ctx.fillStyle = '#fffaf0';
                    this.ctx.fillRect(0, y, this.canvas.width, this.canvas.height - y);
                }
                
                // ç»˜åˆ¶åˆ†éš”çº¿
                this.ctx.strokeStyle = POSTER_CONFIG.colors.borderLight;
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.moveTo(this.padding, y);
                this.ctx.lineTo(width - this.padding, y);
                this.ctx.stroke();
                
                y += 35;
                
                // é‡æ–°è®¾è®¡ä¸¤æ å¸ƒå±€
                const qrSize = 85;
                const qrX = width - this.padding - qrSize;
                const qrY = y;
                const textAreaWidth = qrX - this.padding - 20; // ç•™å‡ºé—´è·
                
                // ç»˜åˆ¶å·¦ä¾§æ–‡æœ¬ï¼ˆç¡®ä¿ä¸ä¼šè¶…å‡ºï¼‰
                let textY = y;
                this.textRenderer.setStyle(16, 'normal');
                this.ctx.fillStyle = POSTER_CONFIG.colors.textLight;
                this.ctx.textAlign = 'left';
                
                // ç»˜åˆ¶ç¬¬ä¸€è¡Œæ–‡æœ¬
                this.ctx.fillText('æ¯æ—¥æ‘¸é±¼æµ·æŠ¥ Â· ä¸“ä¸ºæ‘¸é±¼äººå£«è®¾è®¡', this.padding, textY);
                textY += 28;
                
                // ç»˜åˆ¶ç¬¬äºŒè¡Œæ–‡æœ¬
                this.textRenderer.setStyle(14, 'normal');
                this.ctx.fillText('æ•°æ®æ¥æºï¼šæ‘¸é±¼ API | æ¯æ—¥æ›´æ–°', this.padding, textY);
                textY += 24;
                
                // ç»˜åˆ¶ç¬¬ä¸‰è¡Œæ–‡æœ¬
                this.ctx.fillText('ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString(), this.padding, textY);
                textY += 24;
                
                // ç»˜åˆ¶æç¤ºæ–‡æœ¬
                this.textRenderer.setStyle(13, 'normal');
                this.ctx.fillText('æœ¬æµ·æŠ¥ä»…ä¾›å¨±ä¹ï¼Œæ‘¸é±¼è™½å¥½ï¼Œå·¥ä½œä¹Ÿè¦è®¤çœŸå“¦ï½', this.padding, textY);
                textY += 30;
                
                // ç»˜åˆ¶å³ä¾§äºŒç»´ç ï¼ˆç¡®ä¿ä½ç½®åˆé€‚ï¼‰
                const finalQrY = Math.max(qrY, y);
                await this.qrManager.draw(qrX, finalQrY, qrSize);
                
                // ç»˜åˆ¶ç‰ˆæƒä¿¡æ¯ï¼ˆç¡®ä¿åœ¨ç”»å¸ƒå†…ï¼‰
                const footerY = Math.max(textY, finalQrY + qrSize) + 25;
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºç”»å¸ƒ
                if (footerY < this.canvas.height - this.padding) {
                    this.textRenderer.setStyle(12, 'normal');
                    this.ctx.fillStyle = '#9ca3af';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('Â© 2024 æ‘¸é±¼æµ·æŠ¥ç”Ÿæˆå™¨ | ä»…ä¾›å¨±ä¹ä½¿ç”¨', width / 2, footerY);
                }
            }
        }

        // å…¨å±€å‡½æ•°
        const posterGenerator = new PosterGenerator();

        async function generatePoster() {
            const date = document.getElementById('dateInput').value;
            const container = document.getElementById('posterContainer');
            const downloadBtn = document.getElementById('downloadBtn');
            
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-stone-600">æ­£åœ¨ç”Ÿæˆç²¾ç¾æµ·æŠ¥...</p>
                </div>
            `;
            
            try {
                const posterImage = await posterGenerator.generate(date);
                
                container.innerHTML = `
                    <div class="w-full max-w-2xl mx-auto">
                        <img src="${posterImage}" alt="æ‘¸é±¼æµ·æŠ¥" class="w-full h-auto rounded-lg shadow-xl border border-stone-200" />
                        <div class="mt-6 flex justify-center gap-4">
                            <button onclick="downloadPoster()" class="btn btn-primary px-6 py-3">
                                ğŸ“¥ ä¸‹è½½æµ·æŠ¥
                            </button>
                        </div>
                    </div>
                `;
                
                downloadBtn.classList.remove('hidden');
                
            } catch (error) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-500 text-4xl mb-4">âŒ</div>
                        <p class="text-red-600 text-lg mb-2">æµ·æŠ¥ç”Ÿæˆå¤±è´¥</p>
                        <p class="text-stone-500">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•</p>
                        <button onclick="generatePoster()" class="btn btn-primary mt-4 px-6 py-2">
                            é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                `;
            }
        }

        function setToday() {
            const today = new Date();
            document.getElementById('dateInput').value = today.toISOString().split('T')[0];
            generatePoster();
        }

        function downloadPoster() {
            const canvas = document.getElementById('drawCanvas');
            const date = document.getElementById('dateInput').value;
            const link = document.createElement('a');
            link.download = `æ‘¸é±¼æµ·æŠ¥-${date}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('dateInput').value = dateStr;
            document.getElementById('dateInput').max = dateStr;
            generatePoster();
        });
    </script>
</body>
</html>
